<div [class]=" colSpan()|| 'col-span-x' || containerClassName() " dir="rtl" style="--input-bg: #ffe2e2">
  <div class="relative rounded-lg bg-[color:var(--input-bg)] w-full">
    <div class="relative rounded-lg px-3 pt-1 w-full">

      <!-- FIELDSET (REAL MATERIAL NOTCH) -->
      <fieldset dir="rtl" class="absolute inset-0 pointer-events-none rounded-lg border transition-colors"
        [class.border-red-400]="errorMessage()" [class.border-purple-600]="focused() || open()"
        [class.border-gray-300]="!errorMessage() && !focused() && !open()" aria-hidden="true">
        <legend class="h-0 overflow-hidden transition-all duration-150 pr-2">
          <span class="text-xs opacity-0 px-1 inline-block whitespace-nowrap" style="max-width: calc(100% - 8px)">
            {{ label() }}
          </span>
        </legend>
      </fieldset>

      <!-- Permanent label -->
       @if (label()) {
<label 
        class="absolute px-1 right-2 -top-[0.7rem] text-xs font-sans transition-colors pointer-events-none z-10"
        [class.text-red-500]="errorMessage()" [class.text-purple-600]="focused() || open()"
        [class.text-gray-600]="!errorMessage() && !focused() && !open()" style="background: transparent">
        {{ label() }}
      </label>
       }
      

      <!-- Button -->
      <button type="button" (click)="toggleOpen()" (focus)="focused.set(true)" (blur)="focused.set(false)"
        class="relative w-full cursor-default bg-transparent py-3 pl-10 pr-1 text-right text-xs" aria-haspopup="listbox"
        [attr.aria-expanded]="open()">
        <span class="block truncate text-gray-600 font-sans">{{ buttonText() }}</span>
        <span class="pointer-events-none absolute inset-y-0 left-0 flex items-center">
          <!-- chevron -->
          <svg class="h-5 w-5 left-0 transition-transform duration-200" xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24" fill="none" stroke="currentColor" [class.text-purple-500]="focused() && open()"
            [class.text-gray-400]="!focused() || !open()">
            <path d="M6 9l6 6 6-6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        </span>
      </button>

      <!-- Dropdown -->
       @if (open()) {
      <div 
        class="absolute z-10 mt-1 w-full right-0 overflow-auto rounded-md py-1 bg-[color:var(--input-bg)] shadow-lg border border-purple-600"
        role="listbox" aria-label="Select options">
        <!-- Search -->
         @if (searchable()) {
        <div  class="px-1 pb-1 top-0 font-sans bg-[color:var(--input-bg)]">
          <div class="relative">
            <!-- Search Icon -->
            <svg class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none h-4 w-3"
              xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M21 21l-4.35-4.35m0 0A7.5 7.5 0 1110.5 3a7.5 7.5 0 016.15 13.65z" />
            </svg>

            <!-- Input -->
            <input type="text" [value]="query()" (input)="query.set($any($event.target).value)"
              (keydown)="onQueryKeydown($event)" placeholder="جستجو..."
              class="w-full border border-gray-300 rounded-md px-5 py-2 text-sm focus:ring-1/2 focus:border-purple-500 focus:outline-none focus:ring-purple-500 bg-[var(--input-bg)]" />
          </div>
        </div>
         }


        <!-- Empty -->
         @if (filteredOptions().length === 0) {
 <div  class="px-3 py-2 text-gray-500 text-sm text-center font-sans">
          نتیجه‌ای یافت نشد
        </div>
         }
       

        <!-- Select all -->
         @if (multiple() && showSelectAll() && filteredOptions().length > 0) {
  <button type="button"
          (click)="handleSelectAll()"
          class="relative cursor-default select-none py-2 px-3 border-b border-gray-300 w-full text-[13px] text-right font-sans hover:text-purple-600 text-gray-900">
          <div class="flex items-center justify-between">
            <span [class.text-purple-600]="areAllSelected()" class="block truncate font-medium text-right">
              {{ areAllSelected() ? deselectAllText() : selectAllText() }}
            </span>
            <div class="flex items-center justify-center w-5 h-5 border-2 rounded mr-3"
              [class.bg-purple-600]="areAllSelected()" [class.border-purple-600]="areAllSelected()"
              [class.border-gray-300]="!areAllSelected()">
              @if (areAllSelected()) {
 <svg  class="h-3 w-3 text-white" viewBox="0 0 24 24" fill="none"
                stroke="currentColor">
                <path d="M20 6L9 17l-5-5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
              }
             
            </div>
          </div>
        </button>

         }
      
        <!-- Options -->
         @for (option of filteredOptions(); track option) {
         <div (click)="toggleOption(option)" role="option" [attr.aria-selected]="isSelected(option)"
            class="relative cursor-default select-none py-2 px-3 text-sm font-sans hover:text-purple-600 text-gray-700 flex items-center justify-between"
            [class.text-purple-600]="isSelected(option)">
            <span [class.font-medium]="isSelected(option)" class="block truncate">{{ option.label }}</span>
@if (multiple()) {
 <div  class="flex items-center justify-center w-5 h-5 border-2 rounded"
              [class.bg-purple-600]="isSelected(option)" [class.border-purple-600]="isSelected(option)"
              [class.border-gray-300]="!isSelected(option)">
              @if (isSelected(option)) {
<svg  class="h-3 w-3 text-white" viewBox="0 0 24 24" fill="none"
                stroke="currentColor">
                <path d="M20 6L9 17l-5-5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
              }          
            </div>
}
          </div>
         }
      </div>
       }
    </div>
  </div>

  <!-- Error text -->
   @if (errorMessage()) {
<p class="text-red-500 text-sm mt-1">{{ errorMessage() }}</p>
   }
  
</div>